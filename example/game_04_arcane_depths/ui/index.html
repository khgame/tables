<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Arcane Depths â€“ tables ç¤ºä¾‹</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;500;600;700&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <script>
      tailwind = {
        theme: {
          extend: {
            fontFamily: {
              display: ['"Space Grotesk"', 'system-ui'],
              body: ['"Prompt"', 'system-ui']
            },
            colors: {
              abyss: '#0b132b',
              ember: '#ef8354',
              aurora: '#4ecdc4',
              starlight: '#b084f7',
              moss: '#7bd389',
              slate: '#1c2541',
              veil: '#3a506b'
            },
            dropShadow: {
              brand: '0 8px 20px rgba(176, 132, 247, 0.35)'
            }
          }
        }
      }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
      body {
        font-family: 'Prompt', system-ui;
        background: radial-gradient(circle at 0% -10%, rgba(78, 205, 196, 0.18), transparent 45%),
                    radial-gradient(circle at 100% 0%, rgba(176, 132, 247, 0.22), transparent 52%),
                    radial-gradient(circle at 50% 100%, rgba(239, 131, 84, 0.16), transparent 50%),
                    #05070f;
        color: white;
        min-height: 100vh;
      }
      .glass-panel {
        backdrop-filter: blur(22px) saturate(130%);
        background: linear-gradient(135deg, rgba(21, 30, 56, 0.92), rgba(26, 19, 43, 0.85));
        border: 1px solid rgba(115, 129, 188, 0.35);
      }
      .glass-soft {
        backdrop-filter: blur(18px) saturate(120%);
        background: linear-gradient(135deg, rgba(36, 52, 86, 0.86), rgba(25, 33, 56, 0.82));
        border: 1px solid rgba(136, 160, 255, 0.2);
      }
      .bg-grid {
        background-image: linear-gradient(rgba(255, 255, 255, 0.05) 1px, transparent 1px),
          linear-gradient(90deg, rgba(255, 255, 255, 0.04) 1px, transparent 1px);
        background-size: 60px 60px;
      }
      .scroll-shadow {
        mask-image: linear-gradient(180deg, transparent 0, black 32px, black calc(100% - 32px), transparent 100%);
      }
    </style>
  </head>
  <body class="bg-grid">
    <div class="min-h-screen max-w-[1320px] mx-auto px-5 md:px-8 lg:px-10 py-10">
      <header class="glass-panel rounded-4xl p-8 md:p-10 drop-shadow-brand">
        <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6">
          <div class="space-y-4">
            <p class="uppercase tracking-[0.5em] text-sm text-starlight/70 font-semibold">@khgame/tables showcase</p>
            <h1 class="font-display text-4xl md:text-5xl lg:text-6xl font-semibold text-white">
              Arcane Depths
            </h1>
            <p class="text-white/80 max-w-2xl">
              ä¸€ä¸ªç”± Excel é…ç½®é©±åŠ¨çš„â€œæˆ˜æœ¯ Roguelike + åŸºåœ°ç»è¥â€ç¤ºä¾‹ã€‚é€šè¿‡ tables æ’ä»¶æµæ°´çº¿ç”Ÿæˆ schemaã€è½¬æ¢ç»“æœä¸ jsonx åè®®ï¼Œå¿«é€Ÿæ­å»ºå¯ä½“éªŒçš„æ¸¸æˆ MVPã€‚
            </p>
            <div class="flex flex-wrap gap-3">
              <span class="inline-flex items-center gap-2 rounded-full px-4 py-2 text-xs font-semibold bg-veil/70 text-starlight/80 border border-starlight/30">
                <span class="text-starlight">â—</span> å¤šå±‚åœ°ç‰¢ & ç« èŠ‚è¢«åŠ¨
              </span>
              <span class="inline-flex items-center gap-2 rounded-full px-4 py-2 text-xs font-semibold bg-veil/70 text-aurora/80 border border-aurora/30">
                <span class="text-aurora">â—</span> Excel â†’ tables â†’ React
              </span>
              <span class="inline-flex items-center gap-2 rounded-full px-4 py-2 text-xs font-semibold bg-veil/70 text-ember/80 border border-ember/30">
                <span class="text-ember">â—</span> jsonx åè®®å¤´è¾“å‡º
              </span>
            </div>
          </div>
          <div class="glass-soft rounded-3xl p-6 md:p-7 w-full lg:w-80 border border-white/10">
            <p class="text-sm text-white/60 uppercase tracking-[0.4em] mb-2">Quick Start</p>
            <ol class="space-y-2 text-sm text-white/80">
              <li>1. è¿è¡Œ <code class="bg-black/40 px-2 py-0.5 rounded border border-white/10 text-aurora">node _rebuild_data.js</code></li>
              <li>2. è¿è¡Œ <code class="bg-black/40 px-2 py-0.5 rounded border border-white/10 text-aurora">node serialize.js</code></li>
              <li>3. ä½¿ç”¨é™æ€æœåŠ¡å™¨æ‰“å¼€ <code>ui/index.html</code></li>
              <li>4. å€ŸåŠ© Chrome Dev MCP è°ƒè¯•ï¼Œæ‰©å±•ç©æ³•</li>
            </ol>
            <p class="text-xs text-white/40 mt-4">
              å½“å‰é¡µé¢ç›´æ¥æ¶ˆè´¹ <code>/out</code> ä¸‹çš„ JSON / JSONX äº§ç‰©ã€‚
            </p>
          </div>
        </div>
      </header>

      <main class="mt-10">
        <div id="app"></div>
      </main>
    </div>

    <script type="text/babel">
      const { useEffect, useState, useMemo } = React;

      const SECTIONS = [
        { id: 'overview', label: 'åŸºåœ°æ¦‚è§ˆ', emoji: 'ğŸ•ï¸' },
        { id: 'squad', label: 'å°é˜Ÿé…ç½®', emoji: 'âš”ï¸' },
        { id: 'map', label: 'åœ°ç‰¢çº¿è·¯', emoji: 'ğŸ—ºï¸' },
        { id: 'battle', label: 'æˆ˜æ–—é¢„è§ˆ', emoji: 'ğŸ”¥' },
        { id: 'events', label: 'äº‹ä»¶ç°¿', emoji: 'ğŸ“œ' }
      ];

      const DATA_BASE = '..';
      const DATA_FILES = [
        { key: 'chapters', file: `${DATA_BASE}/chapters.json` },
        { key: 'mapTemplates', file: `${DATA_BASE}/map_templates.json` },
        { key: 'classes', file: `${DATA_BASE}/classes.json` },
        { key: 'heroes', file: `${DATA_BASE}/heroes.json` },
        { key: 'skills', file: `${DATA_BASE}/skills.json` },
        { key: 'skillLinks', file: `${DATA_BASE}/skill_links.json` },
        { key: 'enemies', file: `${DATA_BASE}/enemies.json` },
        { key: 'enemyAI', file: `${DATA_BASE}/enemy_ai.json` },
        { key: 'rooms', file: `${DATA_BASE}/rooms.json` },
        { key: 'events', file: `${DATA_BASE}/events.json` },
        { key: 'relics', file: `${DATA_BASE}/relics.json` },
        { key: 'equipment', file: `${DATA_BASE}/equipment.json` },
        { key: 'facilities', file: `${DATA_BASE}/facilities.json` },
        { key: 'research', file: `${DATA_BASE}/research.json` },
        { key: 'economy', file: `${DATA_BASE}/economy.json` },
        { key: 'tasks', file: `${DATA_BASE}/tasks.json` },
        { key: 'achievements', file: `${DATA_BASE}/achievements.json` }
      ];

      const fetchJSON = async (file) => {
        const res = await fetch(file);
        if (!res.ok) throw new Error(`${file} ${res.status}`);
        return res.json();
      };

      const toEntries = (convert) => {
        const result = convert?.result || {};
        return Object.entries(result).map(([id, value]) => ({ id: Number(id), ...value }));
      };

      const useArcaneData = () => {
        const [state, setState] = useState({ loading: true, error: null, data: {} });
        useEffect(() => {
          let cancelled = false;
          (async () => {
            try {
              const entries = await Promise.all(DATA_FILES.map(async ({ key, file }) => {
                const json = await fetchJSON(file);
                return [key, { raw: json, list: toEntries(json) }];
              }));
              if (cancelled) return;
              const data = Object.fromEntries(entries);
              setState({ loading: false, error: null, data });
            } catch (err) {
              console.error('[arcane-depths] load error', err);
              if (!cancelled) setState({ loading: false, error: err, data: {} });
            }
          })();
          return () => { cancelled = true; };
        }, []);
        return state;
      };

      const formatNumber = (value) => {
        if (value == null) return '--';
        const n = Number(value);
        if (Number.isNaN(n)) return value;
        if (Math.abs(n) >= 1e6) return (n / 1e6).toFixed(1) + 'M';
        if (Math.abs(n) >= 1e3) return (n / 1e3).toFixed(1) + 'K';
        return n.toString();
      };

      const accentClassMap = {
        starlight: 'text-starlight',
        aurora: 'text-aurora',
        ember: 'text-ember',
        moss: 'text-moss',
        white: 'text-white'
      };

      const tagToneMap = {
        veil: 'bg-veil/50 text-white/70 border-white/10',
        aurora: 'bg-aurora/20 text-aurora border-aurora/40',
        ember: 'bg-ember/20 text-ember border-ember/40',
        starlight: 'bg-starlight/20 text-starlight border-starlight/40'
      };

      const StatCard = ({ label, value, accent = 'starlight' }) => (
        <div className="glass-soft rounded-2xl px-5 py-4 border border-white/5 flex flex-col gap-1">
          <span className="text-xs uppercase tracking-[0.4em] text-white/50">{label}</span>
          <span className={`text-2xl font-semibold ${accentClassMap[accent] || 'text-white'}`}>{value}</span>
        </div>
      );

      const Tag = ({ label, tone = 'veil' }) => (
        <span className={`inline-flex items-center gap-1 rounded-full px-3 py-1 text-xs font-semibold ${tagToneMap[tone] || tagToneMap.veil}`}>{label}</span>
      );

      const SectionTitle = ({ title, subtitle }) => (
        <div className="flex flex-col gap-2 mb-6">
          <h2 className="text-2xl font-display font-semibold">{title}</h2>
          {subtitle ? <p className="text-sm text-white/60 max-w-2xl">{subtitle}</p> : null}
        </div>
      );

      const OverviewPanel = ({ data }) => {
        const facilities = data.facilities?.list || [];
        const research = data.research?.list || [];
        const tasks = data.tasks?.list || [];
        const achievements = data.achievements?.list || [];
        const economy = data.economy?.list || [];

        const campFacilities = facilities.filter(f => f.type === 'Camp');
        const workshopFacilities = facilities.filter(f => f.type === 'Workshop');

        const incomeByResource = useMemo(() => {
          const map = new Map();
          economy.forEach(entry => {
            const key = entry.resource;
            const prev = map.get(key) || { reward: 0, consumption: 0 };
            map.set(key, {
              reward: prev.reward + (Number(entry.rewardAmount) || 0),
              consumption: prev.consumption + (Number(entry.consumption) || 0)
            });
          });
          return Array.from(map.entries()).map(([resource, value]) => ({ resource, ...value }));
        }, [economy]);

        return (
          <div className="space-y-8">
            <SectionTitle title="è¥åœ°çŠ¶æ€" subtitle="å¿«é€Ÿæµè§ˆåŸºåœ°è®¾æ–½ã€ç ”ç©¶è·¯å¾„ä¸èµ„æºæµå‘ã€‚" />
            <div className="grid md:grid-cols-4 gap-4">
              <StatCard label="è®¾æ–½æ€»æ•°" value={facilities.length} accent="starlight" />
              <StatCard label="ç ”ç©¶èŠ‚ç‚¹" value={research.length} accent="aurora" />
              <StatCard label="ç« èŠ‚ä»»åŠ¡" value={tasks.length} accent="moss" />
              <StatCard label="è´¦å·æˆå°±" value={achievements.length} accent="ember" />
            </div>

            <div className="grid lg:grid-cols-2 gap-6">
              <div className="space-y-4">
                <h3 className="text-lg font-semibold flex items-center gap-2">
                  <span className="text-aurora">â—ˆ</span> è¥åœ°æ ¸å¿ƒè®¾æ–½
                </h3>
                <div className="space-y-3 max-h-72 overflow-auto scroll-shadow pr-2">
                  {campFacilities.map(fac => (
                    <div key={fac.id} className="glass-soft rounded-2xl p-4 border border-white/10">
                      <div className="flex items-start justify-between gap-4">
                        <div>
                          <p className="text-white text-base font-semibold">{fac.name}</p>
                          <p className="text-xs uppercase tracking-[0.4em] text-white/40">Lv.{fac.level} Â· {fac.type}</p>
                        </div>
                        <Tag label={`${fac.unlockResource} ${fac.unlockAmount}`} tone="veil" />
                      </div>
                      <p className="text-sm text-white/70 mt-2">{fac.effectSummary}</p>
                      {fac.unlockRequirement ? <p className="text-xs text-white/40 mt-2">è§£é”æ¡ä»¶ï¼š{fac.unlockRequirement}</p> : null}
                    </div>
                  ))}
                  {campFacilities.length === 0 ? <p className="text-sm text-white/40">æš‚æ— è¥åœ°è®¾æ–½æ•°æ®ã€‚</p> : null}
                </div>
              </div>

              <div className="space-y-4">
                <h3 className="text-lg font-semibold flex items-center gap-2">
                  <span className="text-starlight">â—ˆ</span> å·¥åŠä¸ç ”ç©¶è·¯çº¿
                </h3>
                <div className="space-y-3 max-h-72 overflow-auto scroll-shadow pr-2">
                  {research.map(node => (
                    <div key={node.id} className="glass-soft rounded-2xl p-4 border border-white/10">
                      <div className="flex items-center justify-between gap-4">
                        <div>
                          <p className="text-white text-base font-semibold">{node.name}</p>
                          <p className="text-xs text-white/40">æ¶ˆè€— {node.costResource} {node.costAmount}</p>
                        </div>
                        <Tag label={node.rewardType} tone="veil" />
                      </div>
                      <p className="text-sm text-white/70 mt-2">å¥–åŠ±ï¼š{node.rewardValue}</p>
                      {node.parent ? <p className="text-xs text-white/40 mt-2">å‰ç½®ç ”ç©¶ï¼š#{node.parent}</p> : null}
                    </div>
                  ))}
                  {research.length === 0 ? <p className="text-sm text-white/40">æš‚æ— ç ”ç©¶èŠ‚ç‚¹ã€‚</p> : null}
                </div>
              </div>
            </div>

            <div className="space-y-4">
              <h3 className="text-lg font-semibold flex items-center gap-2">
                <span className="text-ember">â—ˆ</span> èµ„æºæµå‘æ¦‚è§ˆ
              </h3>
              <div className="grid md:grid-cols-3 gap-4">
                {incomeByResource.map(item => (
                  <div key={item.resource} className="glass-soft rounded-2xl p-4 border border-white/10">
                    <p className="text-sm text-white/60 uppercase tracking-[0.3em]">{item.resource}</p>
                    <p className="text-2xl font-semibold text-white mt-2">+{formatNumber(item.reward)}</p>
                    <p className="text-xs text-white/40">æ¶ˆè€— {formatNumber(item.consumption)}</p>
                  </div>
                ))}
                {incomeByResource.length === 0 ? (
                  <p className="text-sm text-white/40">ç»æµæ•°æ®å°šæœªé…ç½®ã€‚</p>
                ) : null}
              </div>
            </div>
          </div>
        );
      };

      const SquadPanel = ({ data }) => {
        const heroes = data.heroes?.list || [];
        const classes = data.classes?.list || [];
        const skills = data.skills?.list || [];
        const relics = data.relics?.list || [];
        const skillMap = useMemo(() => new Map(skills.map(skill => [skill.id, skill])), [skills]);
        const classMap = useMemo(() => new Map(classes.map(cls => [cls.id, cls])), [classes]);

        const [activeHeroId, setActiveHeroId] = useState(() => heroes[0]?.id);
        useEffect(() => {
          if (!heroes.some(h => h.id === activeHeroId)) {
            setActiveHeroId(heroes[0]?.id);
          }
        }, [heroes, activeHeroId]);

        const activeHero = heroes.find(hero => hero.id === activeHeroId);
        const heroClass = classMap.get(activeHero?.classTid);
        const heroSkills = [activeHero?.signatureSkill, activeHero?.supportSkill, activeHero?.ultimateSkill]
          .map(id => skillMap.get(Number(id)))
          .filter(Boolean);
        const synergyRelics = relics.filter(relic => relic.synergyTrait === activeHero?.primaryTrait || relic.synergyTrait === activeHero?.secondaryTrait);

        return (
          <div className="space-y-6">
            <SectionTitle title="å°é˜Ÿé˜µå®¹" subtitle="æ¥è‡ª Excel çš„è‹±é›„ã€èŒä¸šã€æŠ€èƒ½ä¸ååŒå…³ç³»ã€‚ç‚¹å‡»å·¦ä¾§å¡ç‰‡æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯ã€‚" />
            <div className="grid lg:grid-cols-[280px,1fr] gap-6">
              <div className="space-y-3 overflow-auto max-h-[520px] pr-2 scroll-shadow">
                {heroes.map(hero => (
                  <button
                    key={hero.id}
                    onClick={() => setActiveHeroId(hero.id)}
                    className={`w-full text-left rounded-2xl border px-4 py-3 transition ${activeHeroId === hero.id ? 'border-starlight/60 bg-starlight/15' : 'border-white/10 bg-white/5 hover:bg-white/10'}`}
                  >
                    <p className="text-sm uppercase tracking-[0.3em] text-white/50">{hero.role}</p>
                    <p className="text-lg font-semibold text-white">{hero.name}</p>
                    <div className="flex items-center gap-2 mt-1">
                      <Tag label={`R${hero.rarity}`} tone="veil" />
                      <Tag label={hero.primaryTrait} tone="veil" />
                      {hero.secondaryTrait ? <Tag label={hero.secondaryTrait} tone="veil" /> : null}
                    </div>
                  </button>
                ))}
                {heroes.length === 0 ? <p className="text-sm text-white/40">æš‚æ— è‹±é›„æ•°æ®ã€‚</p> : null}
              </div>

              <div className="space-y-6">
                {activeHero ? (
                  <div className="glass-soft rounded-3xl p-6 border border-white/10">
                    <div className="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-6">
                      <div className="space-y-2">
                        <p className="text-xs uppercase tracking-[0.4em] text-white/40">Hero #{activeHero.id}</p>
                        <h3 className="text-3xl font-display font-semibold text-white">{activeHero.name}</h3>
                        <p className="text-sm text-white/70 max-w-xl">è§£é”ç« èŠ‚ï¼š{activeHero.unlockChapter}</p>
                        {heroClass ? (
                          <p className="text-sm text-white/60">èŒä¸šï¼š{heroClass.name} Â· èƒ½é‡å›å¤ {heroClass.energyRegen}</p>
                        ) : null}
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-3 pt-4">
                          <StatCard label="HP" value={activeHero.baseHp} accent="aurora" />
                          <StatCard label="ATK" value={activeHero.baseAtk} accent="ember" />
                          <StatCard label="DEF" value={activeHero.baseDef} accent="starlight" />
                          <StatCard label="SPD" value={activeHero.baseSpd} accent="moss" />
                        </div>
                      </div>
                      <div className="w-full lg:w-56">
                        <div className="relative rounded-3xl overflow-hidden aspect-[3/4] border border-white/10">
                          <img src={activeHero.portrait} alt={activeHero.name} className="w-full h-full object-cover" />
                          <div className="absolute inset-0 bg-gradient-to-t from-black/60 via-black/10 to-transparent"></div>
                        </div>
                      </div>
                    </div>

                    <div className="mt-6 space-y-4">
                      <h4 className="text-lg font-semibold flex items-center gap-2"><span className="text-starlight">â—ˆ</span> æŠ€èƒ½ç»„åˆ</h4>
                      <div className="grid md:grid-cols-3 gap-4">
                        {heroSkills.map(skill => (
                          <div key={skill.id} className="glass-soft rounded-2xl p-4 border border-white/10">
                            <p className="text-xs uppercase tracking-[0.3em] text-white/40">{skill.tag}</p>
                            <p className="text-lg font-semibold text-white">{skill.name}</p>
                            <p className="text-xs text-white/50 mt-1">ç›®æ ‡ï¼š{skill.target} Â· å†·å´ {skill.cooldown} Â· èƒ½é‡ {skill.energyCost}</p>
                            <p className="text-sm text-white/70 mt-3">{skill.description}</p>
                          </div>
                        ))}
                        {heroSkills.length === 0 ? <p className="text-sm text-white/40">æŠ€èƒ½æœªé…ç½®ã€‚</p> : null}
                      </div>

                      {synergyRelics.length ? (
                        <div className="space-y-3">
                          <h4 className="text-lg font-semibold flex items-center gap-2"><span className="text-aurora">â—ˆ</span> ååŒé—ç‰©</h4>
                          <div className="grid md:grid-cols-2 gap-3">
                            {synergyRelics.map(relic => (
                              <div key={relic.id} className="glass-soft rounded-2xl p-4 border border-white/10">
                                <p className="text-sm text-white font-semibold">{relic.name}</p>
                                <p className="text-xs text-white/40">ç¨€æœ‰åº¦ {relic.rarity} Â· è§¦å‘ {relic.triggerCondition}</p>
                                <p className="text-sm text-white/70 mt-1">{relic.effectSummary}</p>
                              </div>
                            ))}
                          </div>
                        </div>
                      ) : null}
                    </div>
                  </div>
                ) : <p className="text-sm text-white/40">è¯·é€‰æ‹©ä¸€ä¸ªè‹±é›„æŸ¥çœ‹è¯¦æƒ…ã€‚</p>}
              </div>
            </div>
          </div>
        );
      };

      const MapPanel = ({ data }) => {
        const chapters = data.chapters?.list || [];
        const mapTemplates = data.mapTemplates?.list || [];
        const rooms = data.rooms?.list || [];
        const roomById = useMemo(() => new Map(rooms.map(room => [room.id, room])), [rooms]);
        const [activeChapterId, setActiveChapterId] = useState(() => chapters[0]?.id);

        const layers = useMemo(() => {
          const filtered = mapTemplates.filter(node => (activeChapterId ? Number(node.chapterId) === Number(activeChapterId) : true));
          const group = new Map();
          filtered.forEach(node => {
            const key = node.layer || 0;
            const arr = group.get(key) || [];
            arr.push(node);
            group.set(key, arr);
          });
          return Array.from(group.entries())
            .sort((a, b) => a[0] - b[0])
            .map(([layer, nodes]) => ({ layer, nodes: nodes.sort((a, b) => (a.order || 0) - (b.order || 0)) }));
        }, [mapTemplates, activeChapterId]);

        const activeChapter = chapters.find(ch => Number(ch.id) === Number(activeChapterId));

        return (
          <div className="space-y-6">
            <SectionTitle
              title="åœ°ç‰¢çº¿è·¯"
              subtitle="æ ¹æ®ç« èŠ‚æ¨¡æ¿ç”Ÿæˆçš„å±‚çº§åœ°å›¾ï¼ŒèŠ‚ç‚¹ç±»å‹ã€æƒé‡ä¸ç‰¹æ€§å‡æ¥æºäº Excelã€‚"
            />

            <div className="flex flex-col lg:flex-row lg:items-center gap-3">
              <label className="text-sm text-white/60">é€‰æ‹©ç« èŠ‚ï¼š</label>
              <select
                className="glass-soft border border-white/10 rounded-xl px-4 py-2 text-sm bg-transparent"
                value={activeChapterId || ''}
                onChange={e => setActiveChapterId(Number(e.target.value))}
              >
                {chapters.map(ch => (
                  <option key={ch.id} value={ch.id}>{ch.name}</option>
                ))}
              </select>
              {activeChapter ? <Tag label={activeChapter.tagline} tone="veil" /> : null}
            </div>

            {activeChapter ? (
              <div className="glass-soft rounded-3xl p-5 border border-white/10">
                <div className="flex flex-col lg:flex-row lg:items-start lg:justify-between gap-5">
                  <div>
                    <p className="text-xs uppercase tracking-[0.4em] text-white/40">ç« èŠ‚è¢«åŠ¨</p>
                    <p className="text-lg font-semibold text-white mt-1">{activeChapter.passiveEffect}</p>
                  </div>
                  <div className="flex flex-wrap gap-2">
                    {(activeChapter.featureRooms || '').split('|').filter(Boolean).map(label => (
                      <Tag key={label} label={label} tone="veil" />
                    ))}
                  </div>
                </div>
              </div>
            ) : null}

            <div className="overflow-x-auto pb-4">
              <div className="flex items-stretch gap-6 min-w-max">
                {layers.map(layer => (
                  <div key={layer.layer} className="min-w-[220px] space-y-3">
                    <div className="glass-soft rounded-2xl px-4 py-2 border border-white/10 flex items-center justify-between">
                      <span className="text-sm text-white/70">ç¬¬ {layer.layer} å±‚</span>
                      <span className="text-white/40 text-xs">èŠ‚ç‚¹ {layer.nodes.length}</span>
                    </div>
                    <div className="space-y-3">
                      {layer.nodes.map(node => {
                        const linkedRoom = roomById.get(Number(node.destinationRoomId || node.nodeCode))
                          || rooms.find(room => room.roomType === node.roomType && Number(room.chapterId) === Number(activeChapterId));
                        return (
                          <div key={`${layer.layer}-${node.order}-${node.nodeCode}`} className="glass-soft rounded-2xl p-4 border border-white/10">
                            <p className="text-xs uppercase tracking-[0.3em] text-white/40">{node.roomType}</p>
                            <p className="text-base text-white font-semibold">
                              {linkedRoom?.name || `èŠ‚ç‚¹ ${node.nodeCode}`}
                            </p>
                            {linkedRoom?.description ? (
                              <p className="text-xs text-white/60 mt-2">{linkedRoom.description}</p>
                            ) : null}
                            <div className="flex flex-wrap gap-2 mt-3">
                              {node.rewardHint ? <Tag label={`å¥–åŠ±ï¼š${node.rewardHint}`} /> : null}
                              {node.weightMod ? <Tag label={`æƒé‡ x${node.weightMod}`} tone="veil" /> : null}
                              {node.specialRule ? <Tag label={node.specialRule} tone="veil" /> : null}
                            </div>
                          </div>
                        );
                      })}
                    </div>
                  </div>
                ))}
                {layers.length === 0 ? <p className="text-sm text-white/40">è¯¥ç« èŠ‚å°šæœªé…ç½®åœ°å›¾æ¨¡æ¿ã€‚</p> : null}
              </div>
            </div>
          </div>
        );
      };

      const BattlePanel = ({ data }) => {
        const heroes = data.heroes?.list || [];
        const skills = data.skills?.list || [];
        const enemies = data.enemies?.list || [];
        const enemyAI = data.enemyAI?.list || [];
        const rooms = data.rooms?.list || [];
        const [activeRoom, setActiveRoom] = useState(() => rooms.find(room => room.roomType === 'Boss'));

        const heroLineup = heroes.slice(0, 4);
        const skillMap = useMemo(() => new Map(skills.map(skill => [skill.id, skill])), [skills]);
        const bossEnemy = useMemo(() => {
          if (!activeRoom?.enemyId) return enemies.find(enemy => enemy.family === 'Aberrant' && enemy.rarity === 'Boss');
          return enemies.find(enemy => Number(enemy.id) === Number(activeRoom.enemyId));
        }, [activeRoom, enemies]);
        const bossAI = useMemo(() => enemyAI.filter(ai => Number(ai.enemyId) === Number(bossEnemy?.id)), [enemyAI, bossEnemy]);

        return (
          <div className="space-y-6">
            <SectionTitle title="æˆ˜æ–—é¢„è§ˆ" subtitle="æ¼”ç¤ºå¯¼è¡¨æ•°æ®å¦‚ä½•é©±åŠ¨æˆ˜æ–—ä¿¡æ¯ï¼šé˜Ÿä¼å±æ€§ã€æŠ€èƒ½ç»„åˆã€Boss è¡Œä¸ºè„šæœ¬ç­‰ã€‚" />

            <div className="flex flex-col lg:flex-row lg:items-center gap-3">
              <label className="text-sm text-white/60">æ¼”ç¤ºæˆ¿é—´ï¼š</label>
              <select
                className="glass-soft border border-white/10 rounded-xl px-4 py-2 text-sm bg-transparent"
                value={activeRoom?.id || ''}
                onChange={e => setActiveRoom(rooms.find(room => Number(room.id) === Number(e.target.value)))}
              >
                {rooms.filter(room => room.roomType === 'Boss' || room.roomType === 'Elite').map(room => (
                  <option key={room.id} value={room.id}>{room.name} Â· {room.roomType}</option>
                ))}
              </select>
            </div>

            <div className="grid lg:grid-cols-[1.2fr,1fr] gap-6">
              <div className="glass-soft rounded-3xl p-6 border border-white/10 space-y-5">
                <h3 className="text-lg font-semibold flex items-center gap-3">
                  <span className="text-aurora text-xl">ç©å®¶é˜µå®¹</span>
                  <span className="text-xs text-white/40">ç¤ºä¾‹ï¼šé¦–å‘ 4 åè‹±é›„</span>
                </h3>
                <div className="grid md:grid-cols-2 gap-4">
                  {heroLineup.map(hero => {
                    const heroSkills = [hero.signatureSkill, hero.supportSkill, hero.ultimateSkill]
                      .map(id => skillMap.get(Number(id)))
                      .filter(Boolean);
                    return (
                      <div key={hero.id} className="glass-soft rounded-2xl p-4 border border-white/10">
                        <div className="flex items-start justify-between gap-4">
                          <div>
                            <p className="text-sm text-white font-semibold">{hero.name}</p>
                            <p className="text-xs text-white/40">R{hero.rarity} Â· {hero.role}</p>
                          </div>
                          <Tag label={`SPD ${hero.baseSpd}`} />
                        </div>
                        <div className="grid grid-cols-3 gap-2 mt-3">
                          <StatCard label="HP" value={hero.baseHp} accent="aurora" />
                          <StatCard label="ATK" value={hero.baseAtk} accent="ember" />
                          <StatCard label="DEF" value={hero.baseDef} accent="starlight" />
                        </div>
                        <div className="mt-3 space-y-2">
                          {heroSkills.map(skill => (
                            <div key={skill.id} className="text-xs text-white/60">
                              <p className="font-semibold text-white/80">{skill.name}</p>
                              <p>ç›®æ ‡ {skill.target} Â· èƒ½é‡ {skill.energyCost} Â· {skill.description}</p>
                            </div>
                          ))}
                        </div>
                      </div>
                    );
                  })}
                </div>
              </div>

              {bossEnemy ? (
                <div className="glass-soft rounded-3xl p-6 border border-white/10 space-y-4">
                  <h3 className="text-lg font-semibold flex items-center gap-3">
                    <span className="text-ember text-xl">Boss æƒ…æŠ¥</span>
                    <Tag label={bossEnemy.family} />
                    <Tag label={`Lv.${bossEnemy.level}`} />
                  </h3>
                  <p className="text-xl font-display text-white">{bossEnemy.name}</p>
                  <div className="grid grid-cols-2 gap-3">
                    <StatCard label="HP" value={bossEnemy.hp} accent="aurora" />
                    <StatCard label="ATK" value={bossEnemy.atk} accent="ember" />
                    <StatCard label="DEF" value={bossEnemy.def} accent="starlight" />
                    <StatCard label="SPD" value={bossEnemy.spd} accent="moss" />
                  </div>
                  <p className="text-sm text-white/60">æ‰è½è¡¨ï¼š{bossEnemy.lootTable}</p>
                  <div className="space-y-2">
                    <h4 className="text-sm text-white/60 uppercase tracking-[0.3em]">è¡Œä¸ºåºåˆ—</h4>
                    <div className="space-y-2 max-h-48 overflow-auto pr-1 scroll-shadow">
                      {bossAI.map(action => (
                        <div key={`${action.enemyId}-${action.sequence}`} className="glass-soft rounded-2xl p-3 border border-white/10">
                          <p className="text-xs text-white/50">ä¼˜å…ˆçº§ {action.priority} Â· æ¡ä»¶ {action.condition}</p>
                          <p className="text-sm text-white/80">åŠ¨ä½œï¼š{action.action} {action.param ? `(${action.param})` : ''}</p>
                        </div>
                      ))}
                      {bossAI.length === 0 ? <p className="text-xs text-white/40">æš‚æ— è¡Œä¸ºè„šæœ¬ã€‚</p> : null}
                    </div>
                  </div>
                </div>
              ) : <p className="text-sm text-white/40">æœªæ‰¾åˆ° Boss æ•°æ®ã€‚</p>}
            </div>
          </div>
        );
      };

      const EventsPanel = ({ data }) => {
        const chapters = data.chapters?.list || [];
        const events = data.events?.list || [];
        const [activeChapterId, setActiveChapterId] = useState(() => chapters[0]?.id);
        const filteredEvents = useMemo(() => events.filter(evt => !activeChapterId || Number(evt.chapterId) === Number(activeChapterId)), [events, activeChapterId]);
        const [activeEventId, setActiveEventId] = useState(() => filteredEvents[0]?.id);

        useEffect(() => {
          const first = filteredEvents[0]?.id;
          if (first && !filteredEvents.some(evt => evt.id === activeEventId)) {
            setActiveEventId(first);
          }
        }, [filteredEvents, activeEventId]);

        const activeEvent = filteredEvents.find(evt => evt.id === activeEventId);

        const renderOption = (label, requirement, rewardType, rewardValue, penaltyType, penaltyValue) => (
          <div className="glass-soft rounded-2xl p-4 border border-white/10">
            <p className="text-sm text-white font-semibold">{label}</p>
            <div className="flex flex-wrap gap-2 mt-2">
              {requirement ? <Tag label={`éœ€æ±‚: ${requirement}`} /> : <Tag label="æ— éœ€æ±‚" />}
              {rewardType ? <Tag label={`å¥–åŠ±: ${rewardType} ${rewardValue || ''}`} tone="veil" /> : null}
              {penaltyType ? <Tag label={`é£é™©: ${penaltyType} ${penaltyValue || ''}`} tone="veil" /> : null}
            </div>
          </div>
        );

        return (
          <div className="space-y-6">
            <SectionTitle title="äº‹ä»¶ç°¿" subtitle="äº‹ä»¶åœ¨ Excel ä¸­å®šä¹‰æ–‡æœ¬ã€é€‰é¡¹ä¸åˆ†æ”¯ï¼Œå¯¼å‡ºåå¯ç›´æ¥é©±åŠ¨äº¤äº’ã€‚" />
            <div className="flex flex-col lg:flex-row lg:items-center gap-3">
              <label className="text-sm text-white/60">ç« èŠ‚ï¼š</label>
              <select
                className="glass-soft border border-white/10 rounded-xl px-4 py-2 text-sm bg-transparent"
                value={activeChapterId || ''}
                onChange={e => setActiveChapterId(Number(e.target.value))}
              >
                {chapters.map(ch => (
                  <option key={ch.id} value={ch.id}>{ch.name}</option>
                ))}
              </select>
            </div>

            <div className="grid lg:grid-cols-[260px,1fr] gap-5">
              <div className="space-y-2 max-h-[420px] overflow-auto pr-2 scroll-shadow">
                {filteredEvents.map(evt => (
                  <button
                    key={evt.id}
                    onClick={() => setActiveEventId(evt.id)}
                    className={`w-full text-left rounded-2xl border px-4 py-3 transition ${activeEventId === evt.id ? 'border-aurora/60 bg-aurora/20' : 'border-white/10 bg-white/5 hover:bg-white/10'}`}
                  >
                    <p className="text-xs uppercase tracking-[0.3em] text-white/40">#{evt.id}</p>
                    <p className="text-sm text-white font-semibold">{evt.title}</p>
                    <p className="text-xs text-white/50 mt-1 line-clamp-2">{evt.summary}</p>
                  </button>
                ))}
                {filteredEvents.length === 0 ? <p className="text-sm text-white/40">è¯¥ç« èŠ‚æš‚æœªé…ç½®äº‹ä»¶ã€‚</p> : null}
              </div>

              <div className="glass-soft rounded-3xl p-6 border border-white/10 space-y-4">
                {activeEvent ? (
                  <>
                    <p className="text-xs uppercase tracking-[0.4em] text-white/40">äº‹ä»¶è¯¦æƒ…</p>
                    <h3 className="text-2xl font-display text-white">{activeEvent.title}</h3>
                    <p className="text-sm text-white/70 max-w-2xl">{activeEvent.summary}</p>
                    <div className="grid md:grid-cols-2 gap-3 pt-4">
                      {renderOption(activeEvent.option1Text || 'é€‰é¡¹ A', activeEvent.option1Requirement, activeEvent.option1RewardType, activeEvent.option1RewardValue, activeEvent.option1PenaltyType, activeEvent.option1PenaltyValue)}
                      {renderOption(activeEvent.option2Text || 'é€‰é¡¹ B', activeEvent.option2Requirement, activeEvent.option2RewardType, activeEvent.option2RewardValue, activeEvent.option2PenaltyType, activeEvent.option2PenaltyValue)}
                    </div>
                    {activeEvent.followUp ? <p className="text-xs text-white/50">åç»­äº‹ä»¶ï¼š#{activeEvent.followUp}</p> : null}
                  </>
                ) : <p className="text-sm text-white/40">è¯·é€‰æ‹©ä¸€ä¸ªäº‹ä»¶ã€‚</p>}
              </div>
            </div>
          </div>
        );
      };

      const App = () => {
        const { loading, error, data } = useArcaneData();
        const [activeSection, setActiveSection] = useState(SECTIONS[0].id);

        let content = null;
        if (loading) {
          content = (
            <div className="h-full flex flex-col items-center justify-center text-white/60 gap-3">
              <span className="animate-pulse text-2xl">åŠ è½½ä¸­â€¦</span>
              <p className="text-sm text-white/40">è¯·ç¡®ä¿å·²æ‰§è¡Œ <code>node serialize.js</code> å¹¶é€šè¿‡é™æ€æœåŠ¡å™¨è®¿é—®ã€‚</p>
            </div>
          );
        } else if (error) {
          content = (
            <div className="h-full flex flex-col items-center justify-center text-red-300 gap-3">
              <p>æ•°æ®åŠ è½½å¤±è´¥ï¼š{String(error.message || error)}</p>
              <p className="text-sm text-white/40">è‹¥ä½¿ç”¨ file:// æ‰“å¼€ï¼Œè¯·æ”¹ç”¨ <code>npx serve</code> ç­‰æœ¬åœ°æœåŠ¡å™¨ã€‚</p>
            </div>
          );
        } else {
          if (activeSection === 'overview') content = <OverviewPanel data={data} />;
          if (activeSection === 'squad') content = <SquadPanel data={data} />;
          if (activeSection === 'map') content = <MapPanel data={data} />;
          if (activeSection === 'battle') content = <BattlePanel data={data} />;
          if (activeSection === 'events') content = <EventsPanel data={data} />;
        }

        return (
          <div className="grid lg:grid-cols-[260px,1fr] gap-6 lg:gap-8">
            <aside className="glass-panel rounded-3xl p-5 lg:p-6 h-full">
              <Nav active={activeSection} onChange={setActiveSection} />
            </aside>
            <section className="glass-panel rounded-3xl p-6 lg:p-8 overflow-hidden">
              <div className="h-full overflow-auto pr-2 scroll-shadow">
                {content}
              </div>
            </section>
          </div>
        );
      };

      const Nav = ({ active, onChange }) => (
        <div className="flex flex-col gap-2">
          {SECTIONS.map(section => (
            <button
              key={section.id}
              onClick={() => onChange(section.id)}
              className={`flex items-center gap-3 rounded-2xl px-4 py-3 border transition text-sm ${active === section.id ? 'border-starlight/60 bg-starlight/15 text-white' : 'border-white/10 bg-white/5 text-white/60 hover:bg-white/10'}`}
            >
              <span className="text-lg">{section.emoji}</span>
              <span className="font-semibold">{section.label}</span>
            </button>
          ))}
        </div>
      );

      const root = ReactDOM.createRoot(document.getElementById('app'));
      root.render(<App />);
    </script>
  </body>
</html>
