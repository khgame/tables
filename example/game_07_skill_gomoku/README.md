# Game 07 — Skill Gomoku Card Mode

> Skill Gomoku = 五子棋棋盘 + 技能卡牌。玩家围绕"张兴朝"与合体技展开攻防，将喜剧小品《技能五子棋》中的梗元素卡牌化。
> 体验上类似于游戏王或炉石传说, 机房和对方可以抽卡, 战斗卡是橙色, 反制卡是紫色, 特殊卡是蓝色. 卡片要华丽, 上边还要有配置表中对应技能的名台词和截图. 中央则是五子棋棋盘. 整个游戏氛围是剑与魔法.
> 大致玩法说明: 核心还是五子棋, 加上技能: 一开始会获得两张技能卡, 然后对方每下三步会获得一张卡, 从第五步开始可以使用技能. 进攻卡使用技能的时机,是我方落子前, 而克制卡的时机是对应的克制条件出现时, 也就是对方使用技能时. 特殊卡则在任意时候发动

## 🎮 快速开始

```bash
# 生成游戏数据和UI
node example/game_07_skill_gomoku/serialize.js

# 打开游戏 (在浏览器中)
open example/game_07_skill_gomoku/out/index.html
```

## ✨ 游戏特色

### 完整的游戏系统
- **五子棋核心**: 15×15 标准棋盘，连成五子获胜
- **卡牌系统**: 16张技能卡，4种类型 (进攻/控制/反击/支持)
- **反击机制**: 完善的 Counter 窗口，可选择反击卡或放弃
- **合体技系统**: 召唤"张兴朝"解锁强力合体技
- **AI对手**: 智能落子策略 + 卡牌使用决策

### 游戏模式
- **双人对战**: 本地对战，轮流操作
- **AI对战**: 挑战智能AI (白方)

## 核心玩法概述

- **基础规则**：
  - 双方在标准 15×15 五子棋盘对弈，仍以连成五子为胜利条件。
  - 棋盘动态结合"什刹海"等设定，技能可改写棋子状态、摧毁格点或重置局面。
- **牌库与抽卡**：
  - 双方牌库均为随机构成（统一卡池）。
  - 开局手牌 2 张。
  - 对手每落子 3 步，你抽 1 张；等价地：双方每进行第 3、6、9……次落子后，即刻抽牌。
  - 起始第 5 步（含）后才能发动技能。
  - 抽牌、技能均不消耗额外行动；弃牌堆可作为拓展机制。
- **卡牌种类与发动时机**：
  - **进攻/控制卡**：限在己方落子前发动（同一回合技能→落子）。
  - **克制/反击卡**：对手准备发动技能时即时响应；若未响应则视作放弃。
  - **特殊/调度卡**：任意时机发动（含回合外）。
  - 所有技能均为一次性消耗道具，除非卡牌文本写明可重复。
- **角色/合体技**：
  - "张兴朝"作为特殊角色，召唤后开启合体技卡（如"我是保洁" "调呈离山·东"）。
  - 合体技需满足前置条件（角色在场、或特定状态达成）。

## 卡牌列表（首版）

### 进攻 / 控制

| 卡牌 | 描述 | 备注 | 名台词 |
| --- | --- | --- | --- |
| 飞沙走石 (Sandstorm) | 指定敌方棋子移出棋盘，进入"什刹海"。 | 敌方可用克制卡"拾金不昧""擒拿"应对。 | 飞沙走石！ |
| 静如止水 (Time Freeze) | 冻结敌方，令其当前与下个回合无法落子或发动技能。 | 对应反制：水滴石穿。 | 静如止水！ |
| 力拔山兮 (Instant Win) | 直接摔坏棋盘并宣布胜利。 | 被"两极反转""东山再起"克制。 | 力拔山兮气盖世！ |
| 棒球，呀咧呀咧 (Baseball Strike) | 与飞沙走石相同，但免疫"擒拿"。 | 仍可被"拾金不昧"挽回。 | 呀咧呀咧！ |
| 时光倒流 (Time Rewind) | 将棋盘状态重置至任意早前状态。 | 高稀有度；多面卡。 | 时光倒流！ |
| 调呈离山·东 (Distract) | 跳过对手 1 回合。合体技, 需"张兴朝"在场并消耗技能五。 | 控制类，允许对手使用克制卡"滚！"等。 | 调呈离山东！ |
| 我是保洁 (Cleaner Service) | 随机扫走对手 1 枚棋子。合体技, 需"张兴朝"在场并消耗技能五。 | 合体技；会被"滚！"打断。 | 我是保洁的！ |

### 反击 / 克制

| 卡牌 | 描述 | 目标 | 名台词 |
| --- | --- | --- | --- |
| 拾金不昧 (Item Retrieval) | 当己方棋子被丢弃时，将其放回其他空位。 | 克制飞沙走石、棒球。 | 拾金不昧！ |
| 擒拿 (Seize) | 阻止飞沙走石使棋子保留原位（对棒球无效）。 | 克制飞沙走石。 | 擒拿！ |
| 水滴石穿 (Break Free) | 解除静如止水冻结，恢复行动。 | 克制静如止水。 | 水滴石穿！ |
| 两极反转 (Reverse Trap) | 当敌方发动力拔山兮时触发，直接反夺胜利。 | 克制力拔山兮。 | 两极反转！ |
| 东山再起 (Resurgence) | 力拔山兮生效后恢复棋盘，继续对局。 | 克制力拔山兮。 | 东山再起！ |
| 滚！(Shout) | 防守合体技：对手发动任意合体技时阻断其效果。 | 克制保洁上门等合体技。 | 滚！ |
| 你骂老人 (Moral Pressure) | 针对"滚！"的反制，仍被打断但可令对方少行动 1 回合。 | 克制滚！。 | 你骂老人！ |

### 特殊 / 调度

| 卡牌 | 描述 | 功能 | 名台词 |
| --- | --- | --- | --- |
| 技能五 (Summon Skill Five) | 召唤张兴朝入场，开启所有合体技。 | 条件卡。 | 技能五！ |
| See You Again (Force Exit) | 强制让对方张兴朝退场；若无目标则作废。 | 反合体技。 | See you again！ |

## 抽牌与节奏控制

1. 开局双方抽 2 张。
2. 每当任一玩家完成第 3、6、9……次落子时（即每 3 步累计），对手立刻抽 1 张。
3. 第 5 步起可发动技能；之前的手牌只能保留。
4. 若牌库耗尽，可启用规则：洗混弃牌堆形成新牌库；可在扩展中定义。

## 数据表设计

- `cards.csv`
  - 字段：`@tid`（卡牌 ID）、`type`、`subtype`、`nameZH`、`nameEN`、`rarity`、`cost`、`speed`、`timing`、`effect`、`triggerCondition`、`counteredBy`、`requires`、`requiresCards`、`failCondition`、`tags`、`notes`、`quote`、`artwork`。
- `characters.csv`
  - 关键角色/召唤物：`@tid`、`roleType`、`name`、`entryEffect`、`exitEffect`、`enablesCards[]`、`defeatCondition`、`quote`、`artwork`。

所有表遵循 tables 标准：首行标记、第二行字段名；必要字段使用 `enum<...>` 引用上下文枚举，插入 `$ghost`/`$strict` 控制可选项；通过 `context.meta.indexes` 配置常用索引。

## 上下文约定

- `context.enums.json`
  - `CardType`、`CardTiming`、`CardSpeed`、`CardRarity`、`RoleType`、`Tag` 等。
  - 可在 `context.enums.cards` 下列出特殊标签，如 `Unseizeable`、`Fusion`、`AntiFusion`。
- `context.meta.json`
  - `indexes.cards`：按 `nameEN`、`type`、`rarity`、`timing`、`requires`、`requiresCards`、`counteredBy`、`tags` 生成索引。
  - 可为 `characters` 等表定义额外索引。

## 输出产物

- `serialize.js` 生成：
  - `out/cards.json`, `out/cardsSolution.ts`, `out/cards.ts`等表对应输出。
  - `out/characters.json`, `out/charactersSolution.ts`, `out/characters.ts`。
  - `out/context.ts`（通过 `serializeContext`）。
  - `out/index.html`：完整的可玩游戏，包含五子棋棋盘、卡牌界面、AI对手。

## 🎯 技术亮点

### 代码架构 (遵循 SOLID & DRY)
- **单一职责** (SRP):
  - `GomokuBoard`: 仅负责五子棋逻辑
  - `CardDeck`: 仅负责卡牌抽取和弃牌
  - `useGameState`: 仅负责游戏状态管理
  - AI逻辑独立于游戏核心

- **依赖倒置** (DIP):
  - UI组件依赖 hook 抽象，不直接操作状态
  - AI通过函数接口与游戏交互

- **开闭原则** (OCP):
  - 卡牌效果通过 tags 扩展，无需修改核心代码
  - 新卡牌只需添加数据，标签自动解析

- **DRY原则**:
  - 卡牌渲染复用 `Card` 组件
  - 玩家名称通过函数生成，避免重复字符串
  - AI评估逻辑统一封装

### 性能优化
- `useMemo`: 缓存反击卡列表计算
- `useCallback`: 优化事件处理函数
- AI搜索剪枝: 跳过远离已有棋子的位置 (减少90%搜索量)

### AI设计
- **启发式评估**: 基于连子数量和空位数量评分
- **智能决策**:
  - 优先检测获胜机会
  - 阻挡对手四连
  - 合理使用技能卡 (30%概率使用直接获胜卡)
  - 60%概率使用反击卡
- **自然延迟**: 800ms落子，1500ms反击，提升体验

## 扩展方向

- **资源系统**：为卡牌增加费用或冷却，避免连续爆发；通过 `cost` 字段 + `Token` 表实现。
- **牌组构筑模式**：允许玩家自选若干卡牌进入牌库，/或设定稀有度权重。
- **增强AI**：
  - Alpha-Beta搜索提升棋力
  - 强化学习训练卡牌策略
  - 多难度等级

## 测试验证

参见 [TESTING.md](./TESTING.md) 完整测试清单。

- ✅ 所有16张卡牌完整实现
- ✅ 反击系统完善 (可选择反击卡或放弃)
- ✅ AI对手智能决策
- ✅ 符合SOLID和DRY原则
- ✅ 无遗留TODO或workaround

---

> 本项目完整展示了 @khgame/tables 的强大能力：从 Excel/CSV 配置到完整可玩游戏，一气呵成。

