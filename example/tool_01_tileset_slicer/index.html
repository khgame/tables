<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <title>Tileset 切片工具 · tables</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <header>
      <h1>Tileset 切片工具</h1>
      <p>上传图像素材，配置 tile 参数，导出 JSON/CSV 配置供 tables 使用。</p>
    </header>

    <main>
      <section class="controls">
        <div class="control-group">
          <label class="file-input">
            <span>选择素材图 (PNG/JPG)</span>
            <input id="fileInput" type="file" accept="image/png,image/jpeg,image/webp" />
          </label>
          <button id="resetBtn" type="button" class="ghost">清空</button>
        </div>

        <div class="preset-section">
          <span class="preset-label">候选 tileset</span>
          <div id="presetList" class="preset-list" role="list"></div>
        </div>

        <div class="control-grid">
          <label>
            <span>Tile 宽度</span>
            <input id="tileWidth" type="number" min="1" value="64" />
          </label>
          <label>
            <span>Tile 高度</span>
            <input id="tileHeight" type="number" min="1" value="64" />
          </label>
          <label>
            <span>边距 Margin</span>
            <input id="margin" type="number" min="0" value="0" />
          </label>
          <label>
            <span>间距 Spacing</span>
            <input id="spacing" type="number" min="0" value="0" />
          </label>
          <label>
            <span>ID 前缀</span>
            <input id="idPrefix" type="text" placeholder="tile" value="tile" />
          </label>
          <label>
            <span>起始索引</span>
            <input id="startIndex" type="number" value="0" />
          </label>
        </div>

        <div class="actions">
          <button id="exportJson" type="button">导出 JSON</button>
          <button id="exportCsv" type="button" class="ghost">导出 CSV</button>
          <button id="copyJson" type="button" class="ghost">复制 JSON</button>
          <span id="status" aria-live="polite"></span>
        </div>
      </section>

      <section class="workspace">
        <div class="canvas-wrapper">
          <canvas id="preview" width="640" height="480"></canvas>
          <div id="overlayInfo" class="overlay" hidden></div>
        </div>
        <aside class="sidebar">
          <div class="summary-layout">
            <div class="summary-card" aria-labelledby="summaryTitle">
              <div class="summary-head">
                <h2 id="summaryTitle">切片概览</h2>
                <dl>
                  <div>
                    <dt>原始尺寸</dt>
                    <dd><span id="imgSize">—</span></dd>
                  </div>
                  <div>
                    <dt>列 × 行</dt>
                    <dd><span id="gridCount">—</span></dd>
                  </div>
                  <div>
                    <dt>Tile 总数</dt>
                    <dd><span id="tileCount">0</span></dd>
                  </div>
                </dl>
              </div>
              <div class="summary-list">
                <h3>预览列表</h3>
                <div id="tileList" class="tile-list"></div>
              </div>
            </div>
            <div class="inspector-stack">
              <div class="inspector-card">
                <h2>属性</h2>
                <div class="inspector-grid">
                  <label>
                    <span>类型</span>
                    <select id="tileRole"></select>
                  </label>
                  <label>
                    <span>分组</span>
                    <input id="tileGroup" type="text" list="tileGroupOptions" placeholder="例如 grass_path" />
                    <datalist id="tileGroupOptions"></datalist>
                  </label>
                  <label>
                    <span>渲染层</span>
                    <select id="tileLayer"></select>
                  </label>
                  <label>
                    <span>可通行</span>
                    <select id="tilePassable">
                      <option value="true">可通行</option>
                      <option value="false">阻挡</option>
                    </select>
                  </label>
                  <label>
                    <span>限定通行者</span>
                    <input id="tilePassableFor" type="text" placeholder="player, vehicle" />
                  </label>
                  <label>
                    <span>标签</span>
                    <input id="tileTags" type="text" placeholder="grass, wet" />
                  </label>
                </div>
              </div>
              <div class="topology-card" id="topologyCard">
                <h2>拓扑标注</h2>
                <p class="hint">道路：点击方向按钮标记四/八向连通；区域：填写中心与边/角地形。</p>
                <div class="direction-grid" aria-live="polite">
                  <button type="button" data-dir="nw" class="dir-btn" title="西北">↖</button>
                  <button type="button" data-dir="n" class="dir-btn" title="北">↑</button>
                  <button type="button" data-dir="ne" class="dir-btn" title="东北">↗</button>
                  <button type="button" data-dir="w" class="dir-btn" title="西">←</button>
                  <div class="dir-center" id="selectedTileLabel">未选中 tile</div>
                  <button type="button" data-dir="e" class="dir-btn" title="东">→</button>
                  <button type="button" data-dir="sw" class="dir-btn" title="西南">↙</button>
                  <button type="button" data-dir="s" class="dir-btn" title="南">↓</button>
                  <button type="button" data-dir="se" class="dir-btn" title="东南">↘</button>
                </div>
                <div class="area-controls">
                  <label class="area-center">
                    <span>中心</span>
                    <input id="areaCenter" type="text" placeholder="草地" />
                  </label>
                  <div class="area-edge-grid">
                    <label>
                      <span>北</span>
                      <input id="areaEdgeN" type="text" placeholder="grass_edge" />
                    </label>
                    <label>
                      <span>东</span>
                      <input id="areaEdgeE" type="text" placeholder="grass_edge" />
                    </label>
                    <label>
                      <span>南</span>
                      <input id="areaEdgeS" type="text" placeholder="grass_edge" />
                    </label>
                    <label>
                      <span>西</span>
                      <input id="areaEdgeW" type="text" placeholder="grass_edge" />
                    </label>
                  </div>
                  <div class="area-corner-grid">
                    <label>
                      <span>西北</span>
                      <input id="areaCornerNW" type="text" placeholder="grass_corner" />
                    </label>
                    <label>
                      <span>东北</span>
                      <input id="areaCornerNE" type="text" placeholder="grass_corner" />
                    </label>
                    <label>
                      <span>东南</span>
                      <input id="areaCornerSE" type="text" placeholder="grass_corner" />
                    </label>
                    <label>
                      <span>西南</span>
                      <input id="areaCornerSW" type="text" placeholder="grass_corner" />
                    </label>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </aside>
      </section>

      <section class="tool-panel" aria-label="工具面板">
        <div class="panel-tabs" role="tablist">
          <button type="button" class="panel-tab active" data-tab-target="board" role="tab" aria-selected="true">画板</button>
          <button type="button" class="panel-tab" data-tab-target="import" role="tab" aria-selected="false">导入配置</button>
        </div>
        <div class="panel-content">
          <div class="panel-pane active" data-pane="board" role="tabpanel">
            <div class="board-pane">
              <p class="hint">使用当前选中的 tile 在画板上绘制地图。</p>
              <div class="board-controls">
                <label>
                  <span>列数</span>
                  <input id="boardCols" type="number" min="1" value="8" />
                </label>
                <label>
                  <span>行数</span>
                  <input id="boardRows" type="number" min="1" value="8" />
                </label>
                <button id="resizeBoard" type="button">调整画板</button>
                <button id="clearBoard" type="button" class="ghost">清空画板</button>
              </div>
              <div class="board-wrapper">
                <canvas id="boardCanvas" width="512" height="512" role="img" aria-label="tileset 画板"></canvas>
              </div>
              <div class="board-actions">
                <button id="exportBoardJson" type="button">导出画板 JSON</button>
                <span id="boardStatus" aria-live="polite"></span>
              </div>
            </div>
          </div>
          <div class="panel-pane" data-pane="import" role="tabpanel" hidden>
            <div class="import-panel">
              <p class="hint">导入之前导出的 JSON，快速恢复切片联通信息或画板布局。</p>
              <div class="import-actions">
                <label class="import-button">
                  <input id="importTilesetInput" type="file" accept="application/json" />
                  导入切片 JSON
                </label>
                <label class="import-button ghost">
                  <input id="importBoardInput" type="file" accept="application/json" />
                  导入画板 JSON
                </label>
              </div>
              <p class="import-note">提示：切片 JSON 会尝试匹配当前素材尺寸；若 meta.source 可访问，也会自动加载原始图片。</p>
              <span id="importStatus" aria-live="polite"></span>
            </div>
          </div>
        </div>
      </section>
    </main>

    <footer>
      <small>
        导出的 JSON 结构：{ "tiles": [{ "id": string, "x": number, "y": number, "width": number, "height": number }],
        "meta": { width, height, tileWidth, tileHeight, margin, spacing }}。
      </small>
    </footer>

    <script src="dist/main.js" type="module"></script>
  </body>
</html>
