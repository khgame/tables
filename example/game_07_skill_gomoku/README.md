# Game 07 — Skill Gomoku Card Mode (技能五子棋)

> Skill Gomoku = 五子棋棋盘 + 技能卡牌
> 体验上类似于游戏王或炉石传说, 机房和对方可以抽卡, 战斗卡是橙色, 反制卡是紫色, 特殊卡是蓝色. 卡片要华丽, 上边还要有配置表中对应技能的名台词和截图. 中央则是五子棋棋盘. 整个游戏氛围是剑与魔法.

## 名词

- **墓地**: 使用后的卡牌按顺序会放入墓地并标记序号, 所有墓地中的卡牌对方可以查阅
- **什刹海**: 从场上因技能清除的棋子会进入什刹海并标记序号，位置，并可查看当时的盘面
- **五子棋**: 传统的五子棋就是在 15×15 标准棋盘，把五个子连成一条线获胜
- **技能五子棋**: 技能五子棋就是在传统的五子棋的基础上加入技能好好玩
- **卡牌系统**: 3种类型 (进攻/反击/支援), 共 16 张技能卡, 体验类似炉石传说等经典卡牌游戏
- **卡牌速度**: 分为 `Instant - 瞬发`（在对方回合结算）与 `Normal - 在落子前正常结算`（按流程排队结算），用于判定多张技能的先后顺序
- **反击机制**: 完善的 Counter 窗口，可选择反击卡或放弃
- **合体技系统**: 召唤"张兴朝"解锁强力合体技
- **AI对手**: 智能落子策略 + 卡牌使用决策

## 界面

[text](UIDESIGN.md)

- 最上方显示对方头像和卡背, 左侧是对方的墓地和什刹海
- 最下方显示我方头像和卡片, 右侧是我方墓地和什刹海
- 头像下显示下子次数和场上棋子数量
- 画面中间左侧是五子棋的棋盘, 右侧是对局记录

## 核心玩法概述

- **基础规则**：
  - 双方在标准 15×15 五子棋盘对弈，仍以连成五子为胜利条件。
  - 棋盘动态结合"什刹海"等设定，技能可改写棋子状态、摧毁格点或重置局面。
- **牌库与抽卡**：
  - 双方牌库均为随机构成（统一卡池），但有一定出现概率
  - 开局阶段直接从 3 张卡中挑选 1 张作为起始牌，无需额外换牌
  - 对手每落子 3 步，你抽 1 张；等价地：双方每进行第 3、6、9……次落子后，即刻抽牌。起始第 6 步（含）后才能发动技能，
  - 每次抽牌会翻出牌堆中随机 3 张供玩家选择 1 张；若剩余牌不足 3 张，则全部展示
  - 抽牌、技能均不消耗额外行动；弃牌堆可作为拓展机制: 若牌库耗尽，可启用规则 - 洗混弃牌堆形成新牌库；可在扩展中定义。
- **卡牌种类与发动时机**：
  - **进攻卡**：如 "飞沙走石", "力拔山兮", 限在己方落子前发动（同一回合技能→落子）
    - **特殊进攻卡**：任意时机发动, 可在己方回合发动, 也可在对方回合发动
  - **反击卡**：对手准备发动技能时即时响应；若未响应则视作放弃
  - 所有技能均为一次性消耗道具，发动后卡牌进入目的
- **角色/合体技**：
  - "技能五"作为特殊角色，召唤后开启合体技卡（如"我是保洁" "调呈离山·东"）。
  - 合体技需满足前置条件（角色在场、或特定状态达成）。
- 游戏模式
  - 双人对战: 本地对战，轮流操作
  - AI对战: 挑战智能AI (白方)

## 卡牌列表

### 进攻卡

| 卡牌 | 张数 | 描述 | 备注 | 卡牌宣言 |
| --- | --- | --- | --- | --- |
| 飞沙走石 (Sandstorm) | 4 | 指定敌方棋子移出棋盘，进入"什刹海"；封禁该落点一回合，同时自己放弃本回合落子 | 敌方可用克制卡 "拾金不昧" "擒拿" 应对。 | 你管这个叫五子棋？ |
| 静如止水 (Time Freeze) | 1 |冻结敌方，跳过对方下一轮落子或发动魔法卡 (反击卡不受影响)。 | 对应反制：水滴石穿。 | 嗯嗯，嗯 |
| 时光倒流 (Time Rewind) | 1 |悔棋：移除双方最近一轮的落子（各移除一手；若某方无落子则忽略），不还原已使用的卡牌/手牌/墓地/牌堆。 | 高稀有度；多面控制。 | 这一招好 |
| 这是棒球 (Baseball Strike) | 1 | 与飞沙走石相同, 合体技, 但免疫一切反制 (擒拿、拾金不昧、滚）。 | 仍可被"拾金不昧"挽回。 | 呀咧呀咧 |
| 调呈离山·东 (Distract) | 1 |跳过对手 1 回合。合体技，需"张兴朝"在场方可发动，技能五不会被消耗。 | 控制类，允许对手使用克制卡"滚！"等。 | 就是调走张呈，离开山东！ |
| 我是保洁 (Cleaner Service) | 1 |随机扫走场上自己和对手的棋子。合体技, 需 "张兴朝" 在场 | 合体技；会被 "滚！"打断。 | 我这招叫做保洁上门 |
| 力拔山兮 (Instant Win) | 1 | 直接摔坏棋盘并宣布胜利。 | 被 "两极反转" "东山再起" 克制。 | 这可是我的最终奥义 |

### 反击卡

| 卡牌 | 张数 | 描述 | 目标 | 卡牌宣言 |
| --- | --- | --- | --- | --- |
| 擒拿 (Seize) | 3 | 阻止飞沙走石使棋子保留原位（对棒球无效）。 | 克制飞沙走石。 | 我只是受过九年制义务教育 |
| 拾金不昧 (Item Retrieval) | 1 | 当己方棋子被丢弃时，将其放回其他空位。 | 克制飞沙走石、棒球。 | 嘿，拾金不昧 |
| 水滴石穿 (Break Free) | 1 | 止水冻结发动时可以触发，解除静如止水，恢复行动。 | 克制静如止水。 | 水滴石穿 |
| 东山再起 (Resurgence) | 1 | 力拔山兮生效后恢复棋盘，继续对局, 且直接跳过对方的当前回合。 | 克制力拔山兮。 | 那我就，东山再起 |
| 两极反转 (Reverse Trap) | 1 | 当敌方发动力拔山兮时或者东山再起时可以触发，直接反夺胜利。合体技, 需 "张兴朝" 在场 | 克制其他直接获得胜利的技能 | 哈哈哈哈哈哈，两极反转 |
| 滚！(Shout) | 2 | 防守合体技：对手发动任意合体技时阻断其效果。 | 克制保洁上门等合体技。 | 诶, 怎么又走了 |
| 你骂老人 (Moral Pressure) | 1 | 针对 "滚！" 的反制，不但不对打断, 同时可跳过下一轮对方的落子 (进攻卡和反击卡不受影响) | 克制滚！。 | 道德绑架 |

#### 支援卡

| 卡牌 | 张数 | 描述 | 功能 | 名台词 |
| --- | 张数 | --- | --- | --- |
| 技能五 (Summon Skill Five) | 1 | 召唤 "张兴朝" 入场，使得合体技成为可能。召唤的当前回合, 无法发动合体技 | 条件卡。 | 技能五子, 张技能五 |
| See You Again (Force Exit) | 1 | 强制让对方张兴朝退场；若无目标则无法发动。 | 反合体技。 | 胜天半子, 王金宝 |

## 🎮 快速开始

```bash
# 生成游戏数据并启动 Vite 本地预览
npm run ex:skill-gomoku:dev

# 构建离线版本 (out/ 下包含 Vite 产物)
npm run ex:skill-gomoku
open example/game_07_skill_gomoku/out/index.html
```

## 数据表设计

- `cards.csv`
  - 字段：`@tid`（卡牌 ID）、`type`、`subtype`、`nameZH`、`nameEN`、`rarity`、`cost`、`speed`、`timing`、`effect`、`triggerCondition`、`counteredBy`、`requires`、`requiresCards`、`failCondition`、`tags`、`notes`、`quote`、`artwork`。
- `characters.csv`
  - 关键角色/召唤物：`@tid`、`roleType`、`name`、`entryEffect`、`exitEffect`、`enablesCards[]`、`defeatCondition`、`quote`、`artwork`。

所有表遵循 tables 标准：首行标记、第二行字段名；必要字段使用 `enum<...>` 引用上下文枚举，插入 `$ghost`/`$strict` 控制可选项；通过 `context.meta.indexes` 配置常用索引。

## 上下文约定

- `context.enums.json`
  - `CardType`、`CardTiming`、`CardSpeed`、`CardRarity`、`RoleType`、`Tag` 等。
  - 可在 `context.enums.cards` 下列出特殊标签，如 `Unseizeable`、`Fusion`、`AntiFusion`。
- `context.meta.json`
  - `indexes.cards`：按 `nameEN`、`type`、`rarity`、`timing`、`requires`、`requiresCards`、`counteredBy`、`tags` 生成索引。
  - 可为 `characters` 等表定义额外索引。

## 输出产物

- `serialize.js` 生成：
  - `out/cards.json`, `out/cardsSolution.ts`, `out/cards.ts`等表对应输出。
  - `out/characters.json`, `out/charactersSolution.ts`, `out/characters.ts`。
  - `out/context.ts`（通过 `serializeContext`）。
  - `out/index.html`：完整的可玩游戏，包含五子棋棋盘、卡牌界面、AI对手。

## 🎯 技术亮点

### 代码架构 (遵循 SOLID & DRY)
- **单一职责** (SRP):
  - `GomokuBoard`: 仅负责五子棋逻辑
  - `CardDeck`: 仅负责卡牌抽取和弃牌
  - `useGameState`: 仅负责游戏状态管理
  - AI逻辑独立于游戏核心

- **依赖倒置** (DIP):
  - UI组件依赖 hook 抽象，不直接操作状态
  - AI通过函数接口与游戏交互

- **开闭原则** (OCP):
  - 卡牌效果通过 tags 扩展，无需修改核心代码
  - 新卡牌只需添加数据，标签自动解析

- **DRY原则**:
  - 卡牌渲染复用 `Card` 组件
  - 玩家名称通过函数生成，避免重复字符串
  - AI评估逻辑统一封装

### UI 体验
- 炉石风格界面：单屏三栏布局，上方展示双方头像与状态，中央木质棋盘满铺
- 卡牌遵循 1:1.618 黄金比例，并由 SVG 绘制炉石风格卡框/卡背；进攻橙、反击紫、特殊蓝，合体技显著标牌
- 左右面板以迷你卡片图标展示墓地与什刹海，附带回合与来源信息，检索更直观
- 目标选择时棋盘高亮可选格与原始位置，对局日志自动滚动区分事件类型

### 技术栈 & 性能
- 全量 TypeScript + React 组件；Vite 负责打包与本地预览
- `useMemo` / `useCallback` 缓存高频计算，降低渲染压力
- AI 搜索剪枝仅评估棋群邻域，并按评分排序候选点以减少分支

### AI设计
- **威胁评估**：Alpha-Beta 搜索结合连子长短与开口信息，提前识别四连/洛阳铲等关键局面
- **优先级排序**：候选落点仅取棋群两格内，并按局面增益排序，大幅削减搜索分支
- **技能/反击策略**：依据局势差值、角色状态与合体技需求触发召唤、冻结、时光倒流等关键牌
- **自然延迟**：落子与反击保持 800ms / 1500ms 动作节奏，贴近炉石式反馈

## 扩展方向

- **资源系统**：为卡牌增加费用或冷却，避免连续爆发；通过 `cost` 字段 + `Token` 表实现。
- **牌组构筑模式**：允许玩家自选若干卡牌进入牌库，/或设定稀有度权重。
- **多难度AI**：引入强化学习或蒙特卡洛模拟，提供更丰富的挑战梯度

## 测试验证

参见 [TESTING.md](./TESTING.md) 完整测试清单。

- ✅ 所有16张卡牌完整实现
- ✅ 反击系统完善 (可选择反击卡或放弃)
- ✅ AI对手智能决策
- ✅ 符合SOLID和DRY原则
- ✅ 无遗留TODO或workaround

---

> 本项目完整展示了 @khgame/tables 的强大能力：从 Excel/CSV 配置到完整可玩游戏，一气呵成。
